openapi: 3.0.3
info:
  title: Api Oder
  description: >-
    API RESTful para gerenciamento de clientes, produtos e pedidos da ApiOrder.
    Inclui soft deletes, seeders para product types, validações e envio de e-mail enfileirado (queued) ao criar pedido.
  version: 1.0.0
servers:
  - url: http://localhost:8000/api/v1
    description: Local
tags:
  - name: Clients
    description: Operações de cliente (CRUDL). E-mail único.
  - name: ProductTypes
    description: Tipos de produto (seed inicial).
  - name: Products
    description: Produtos (foto obrigatória no create).
  - name: Orders
    description: Pedidos (N itens). Ao criar, e-mail é enviado (queued).

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # CLIENT
    Client:
      type: object
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: "João da Silva"
        email:
          type: string
          format: email
          example: "joao@example.com"
        phone:
          type: string
          example: "+55 11 91234-5678"
        birth_date:
          type: string
          format: date
          example: "1990-05-10"
        address:
          type: string
          example: "Rua A, 100"
        complement:
          type: string
          example: "Apto 45"
        neighborhood:
          type: string
          example: "Centro"
        zip:
          type: string
          example: "01234-567"
          pattern: '^[0-9]{5}-?[0-9]{3}$'
        registered_at:
          type: string
          format: date-time
        deleted_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ClientCreate:
      type: object
      required: [name, email]
      properties:
        name: { type: string }
        email: { type: string, format: email }
        phone: { type: string }
        birth_date: { type: string, format: date }
        address: { type: string }
        complement: { type: string }
        neighborhood: { type: string }
        zip: { type: string, pattern: '^[0-9]{5}-?[0-9]{3}$' }
      example:
        name: "Maria Pereira"
        email: "maria@example.com"
        phone: "+55 11 98888-7777"
        birth_date: "1992-10-01"
        address: "Rua A, 100"
        zip: "01234-567"

    # PRODUCT TYPES
    ProductType:
      type: object
      properties:
        id: { type: integer, example: 1 }
        name: { type: string, example: "Salty Pastel" }
        deleted_at: { type: string, format: date-time, nullable: true }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }

    # PRODUCT
    Product:
      type: object
      properties:
        id: { type: integer, example: 10 }
        name: { type: string, example: "Pastel de Queijo" }
        price:
          type: number
          format: float
          minimum: 0.01
          example: 6.5
        photo_path: { type: string, example: "products/pastel-10.jpg" }
        photo_url: { type: string, format: uri, example: "http://localhost/storage/products/pastel-10.jpg" }
        product_type_id: { type: integer, example: 1 }
        deleted_at: { type: string, format: date-time, nullable: true }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }

    ProductCreateForm:
      type: object
      required: [name, price, photo, product_type_id]
      properties:
        name: { type: string }
        price:
          type: number
          format: float
          minimum: 0.01
        product_type_id: { type: integer }
        photo:
          type: string
          format: binary
      example:
        name: "Pastel de Frango"
        price: 7.00
        product_type_id: 1
        # photo is multipart binary

    # ORDER ITEM (snapshot)
    OrderItem:
      type: object
      properties:
        product_id: { type: integer, example: 10 }
        name: { type: string, example: "Pastel de Queijo" }
        unit_price:
          type: number
          format: float
          example: 6.50
        quantity:
          type: integer
          minimum: 1
          example: 2
        subtotal:
          type: number
          format: float
          example: 13.00

    OrderCreate:
      type: object
      required: [client_id, products]
      properties:
        client_id: { type: integer, example: 1 }
        products:
          type: array
          minItems: 1
          items:
            type: object
            required: [product_id, quantity]
            properties:
              product_id: { type: integer }
              quantity: { type: integer, minimum: 1 }
      example:
        client_id: 1
        products:
          - product_id: 10
            quantity: 2
          - product_id: 12
            quantity: 1

    Order:
      type: object
      properties:
        id: { type: integer, example: 100 }
        client_id: { type: integer, example: 1 }
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItem'
        total:
          type: number
          format: float
          example: 29.50
        created_at: { type: string, format: date-time }
        deleted_at: { type: string, format: date-time, nullable: true }

  responses:
    NotFound:
      description: Recurso não encontrado
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
                example: "Resource not found"
    ValidationError422:
      description: Erro de validação
      content:
        application/json:
          schema:
            type: object
            properties:
              message: { type: string, example: "The given data was invalid." }
              errors:
                type: object
                example:
                  email:
                    - "O e-mail informado já é obrigatório e deve ser válido."
                  products:
                    - "O pedido deve conter ao menos 1 produto."
    Conflict409:
      description: Recurso em conflito (ex: e-mail duplicado)
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
                example: "E-mail já cadastrado."

paths:
  /clients:
    get:
      tags: [Clients]
      summary: Listar clientes (paginado)
      parameters:
        - in: query
          name: q
          schema: { type: string }
          description: Busca por nome ou email
        - in: query
          name: page
          schema: { type: integer }
      responses:
        200:
          description: Lista paginada de clientes
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Client'
                  meta:
                    type: object
    post:
      tags: [Clients]
      summary: Criar cliente
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClientCreate'
      responses:
        201:
          description: Cliente criado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Client'
        409:
          $ref: '#/components/responses/Conflict409'
        422:
          $ref: '#/components/responses/ValidationError422'

  /clients/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema: { type: integer }
    get:
      tags: [Clients]
      summary: Obter cliente por id
      responses:
        200:
          description: Cliente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Client'
        404:
          $ref: '#/components/responses/NotFound'
    put:
      tags: [Clients]
      summary: Atualizar cliente (substituir)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClientCreate'
      responses:
        200:
          description: Atualizado
        422:
          $ref: '#/components/responses/ValidationError422'
        409:
          $ref: '#/components/responses/Conflict409'
    patch:
      tags: [Clients]
      summary: Atualizar cliente (parcial)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        200:
          description: Atualizado
    delete:
      tags: [Clients]
      summary: Soft delete do cliente
      responses:
        204:
          description: Removido

  /product-types:
    get:
      tags: [ProductTypes]
      summary: Listar tipos de produto
      responses:
        200:
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ProductType'

  /products:
    get:
      tags: [Products]
      summary: Listar produtos
      responses:
        200:
          description: Lista
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Product'
    post:
      tags: [Products]
      summary: Criar produto (photo obrigatória)
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/ProductCreateForm'
      responses:
        201:
          description: Produto criado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'
        422:
          $ref: '#/components/responses/ValidationError422'

  /products/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema: { type: integer }
    get:
      tags: [Products]
      summary: Obter produto
      responses:
        200:
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'
        404:
          $ref: '#/components/responses/NotFound'
    put:
      tags: [Products]
      summary: Atualizar produto (pode enviar nova foto)
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                name: { type: string }
                price: { type: number, format: float, minimum: 0.01 }
                photo: { type: string, format: binary }
                product_type_id: { type: integer }
      responses:
        200:
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'
        422:
          $ref: '#/components/responses/ValidationError422'
    delete:
      tags: [Products]
      summary: Soft delete do produto
      responses:
        204:
          description: Removido

  /orders:
    get:
      tags: [Orders]
      summary: Listar pedidos
      responses:
        200:
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Order'
    post:
      tags: [Orders]
      summary: Criar pedido (transação + snapshot de preço)
      description: >-
        Cria um pedido com N produtos. O servidor deve:
        1) iniciar transação DB; 2) para cada item buscar produto, salvar unit_price (snapshot),
        calcular subtotal; 3) salvar order + order_items; 4) commit; 5) enfileirar envio de e-mail (Mailable via queue).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderCreate'
      responses:
        201:
          description: Pedido criado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
        422:
          $ref: '#/components/responses/ValidationError422'
        404:
          $ref: '#/components/responses/NotFound'
  /orders/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema: { type: integer }
    get:
      tags: [Orders]
      summary: Obter pedido por id
      responses:
        200:
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
        404:
          $ref: '#/components/responses/NotFound'
    delete:
      tags: [Orders]
      summary: Soft delete do pedido
      responses:
        204:
          description: Removido

# exemplos rápidos de erro
x-examples:
  validation:
    summary: Exemplo 422
    value:
      message: "The given data was invalid."
      errors:
        products:
          - "O pedido deve conter ao menos 1 produto."
        email:
          - "O e-mail deve ser válido."
  conflict:
    summary: Exemplo 409
    value:
      message: "E-mail já cadastrado."
  notFound:
    summary: Exemplo 404
    value:
      message: "Recurso não encontrado."
